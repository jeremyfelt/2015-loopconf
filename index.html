<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Multisite!</title>

		<meta name="description" content="Slides for a talk on WordPress multisite at WordCamp Europe 2016">
		<meta name="author" content="Jeremy Felt">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link href='https://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="reveal.js/css/reveal.css">
		<link rel="stylesheet" href="reveal.js/css/theme/black.css" id="theme">
		<link rel="stylesheet" href="style.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="reveal.js/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section class="title-slide">
					<h1>Multisite!</h1>
					<p>@jeremyfelt</p>
				</section>

				<!-- Image from https://commons.wikimedia.org/wiki/File:Thelonious_Monk,_Minton%27s_Playhouse,_New_York,_N.Y.,_ca._Sept._1947_(William_P._Gottlieb_06231).jpg -->
				<section class="thelonious" data-background="images/thelonious-monk-1947-public-domain-1600x1200.jpg">
					<div class="thelonious-content">

					</div>
				</section>

				<section class="overview-slide no-headline">
					<p><strong>Structure</strong> of multisite and the <strong>bootstrap</strong> process.</p>
					<p>How <strong>plugins and themes</strong> are loaded.</p>
					<p>Importance of <strong>context</strong>.</p>
					<p><strong>Common solutions</strong> to missing features.</p>
				</section>

				<section class="overview-slide">
					<h1>Router of Requests</h1>
				</section>

				<section class="db-slide-zero">
					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables ms-tables-almost-global ms-tables-repurpose" data-markdown>
						* wp_users
						* wp_usermeta
					</div>

				</section>

				<section class="db-slide-one">
					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

				</section>

				<section class="db-slide db-slide-two">
					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>
					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>
					<div class="ms-tables ms-tables-new-site fragment" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site fragment" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships
					</div>
				</section>

				<section class="db-slide db-slide-three">
					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>
					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>
					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships
					</div>
				</section>

				<section class="db-slide db-slide-four">
					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_8_options
						* wp_8_posts
						* wp_8_postmeta
						* wp_8_comments
						* wp_8_commentmeta
						* wp_8_terms
						* wp_8_term_taxonomy
						* wp_8_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_9_options
						* wp_9_posts
						* wp_9_postmeta
						* wp_9_comments
						* wp_9_commentmeta
						* wp_9_terms
						* wp_9_term_taxonomy
						* wp_9_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_10_options
						* wp_10_posts
						* wp_10_postmeta
						* wp_10_comments
						* wp_10_commentmeta
						* wp_10_terms
						* wp_10_term_taxonomy
						* wp_10_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_11_options
						* wp_11_posts
						* wp_11_postmeta
						* wp_11_comments
						* wp_11_commentmeta
						* wp_11_terms
						* wp_11_term_taxonomy
						* wp_11_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_12_options
						* wp_12_posts
						* wp_12_postmeta
						* wp_12_comments
						* wp_12_commentmeta
						* wp_12_terms
						* wp_12_term_taxonomy
						* wp_12_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_13_options
						* wp_13_posts
						* wp_13_postmeta
						* wp_13_comments
						* wp_13_commentmeta
						* wp_13_terms
						* wp_13_term_taxonomy
						* wp_13_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_14_options
						* wp_14_posts
						* wp_14_postmeta
						* wp_14_comments
						* wp_14_commentmeta
						* wp_14_terms
						* wp_14_term_taxonomy
						* wp_14_term_relationships
					</div>
				</section>

				<section class="db-slide db-slide-five">

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_8_options
						* wp_8_posts
						* wp_8_postmeta
						* wp_8_comments
						* wp_8_commentmeta
						* wp_8_terms
						* wp_8_term_taxonomy
						* wp_8_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_9_options
						* wp_9_posts
						* wp_9_postmeta
						* wp_9_comments
						* wp_9_commentmeta
						* wp_9_terms
						* wp_9_term_taxonomy
						* wp_9_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_10_options
						* wp_10_posts
						* wp_10_postmeta
						* wp_10_comments
						* wp_10_commentmeta
						* wp_10_terms
						* wp_10_term_taxonomy
						* wp_10_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_11_options
						* wp_11_posts
						* wp_11_postmeta
						* wp_11_comments
						* wp_11_commentmeta
						* wp_11_terms
						* wp_11_term_taxonomy
						* wp_11_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_12_options
						* wp_12_posts
						* wp_12_postmeta
						* wp_12_comments
						* wp_12_commentmeta
						* wp_12_terms
						* wp_12_term_taxonomy
						* wp_12_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_13_options
						* wp_13_posts
						* wp_13_postmeta
						* wp_13_comments
						* wp_13_commentmeta
						* wp_13_terms
						* wp_13_term_taxonomy
						* wp_13_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_14_options
						* wp_14_posts
						* wp_14_postmeta
						* wp_14_comments
						* wp_14_commentmeta
						* wp_14_terms
						* wp_14_term_taxonomy
						* wp_14_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_15_options
						* wp_15_posts
						* wp_15_postmeta
						* wp_15_comments
						* wp_15_commentmeta
						* wp_15_terms
						* wp_15_term_taxonomy
						* wp_15_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_16_options
						* wp_16_posts
						* wp_16_postmeta
						* wp_16_comments
						* wp_16_commentmeta
						* wp_16_terms
						* wp_16_term_taxonomy
						* wp_16_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_17_options
						* wp_17_posts
						* wp_17_postmeta
						* wp_17_comments
						* wp_17_commentmeta
						* wp_17_terms
						* wp_17_term_taxonomy
						* wp_17_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_18_options
						* wp_18_posts
						* wp_18_postmeta
						* wp_18_comments
						* wp_18_commentmeta
						* wp_18_terms
						* wp_18_term_taxonomy
						* wp_18_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_19_options
						* wp_19_posts
						* wp_19_postmeta
						* wp_19_comments
						* wp_19_commentmeta
						* wp_19_terms
						* wp_19_term_taxonomy
						* wp_19_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_20_options
						* wp_20_posts
						* wp_20_postmeta
						* wp_20_comments
						* wp_20_commentmeta
						* wp_20_terms
						* wp_20_term_taxonomy
						* wp_20_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_21_options
						* wp_21_posts
						* wp_21_postmeta
						* wp_21_comments
						* wp_21_commentmeta
						* wp_21_terms
						* wp_21_term_taxonomy
						* wp_21_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_22_options
						* wp_22_posts
						* wp_22_postmeta
						* wp_22_comments
						* wp_22_commentmeta
						* wp_22_terms
						* wp_22_term_taxonomy
						* wp_22_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_23_options
						* wp_23_posts
						* wp_23_postmeta
						* wp_23_comments
						* wp_23_commentmeta
						* wp_23_terms
						* wp_23_term_taxonomy
						* wp_23_term_relationships
					</div>

					<aside class="notes">
					Multisite is basically using the global blogs and sites tables to figure out what other set of tables to use for the request. After that, almost everything it does is exactly the same as single site for most page loads. Remember this as it's key to understanding many things in multisite and we'll touch on it again later.
					</aside>
				</section>

				<section class="db-slide db-slide-three">

					<div class="ms-tables ms-tables-base">
						&nbsp;
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-dots">
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
						....................................................................................................
					</div>
				</section>

				<section>
					<h1>Capabilties</h1>
					<pre><code>mysql> SELECT * FROM wp_usermeta WHERE meta_key LIKE '%_capabilities';
+----------+---------+-------------------+---------------------------------+
| umeta_id | user_id | meta_key          | meta_value                      |
+----------+---------+-------------------+---------------------------------+
|       10 |       1 | wp_capabilities   | a:1:{s:13:"administrator";b:1;} |
|       32 |       2 | wp_capabilities   | a:1:{s:13:"administrator";b:1;} |
|       47 |       1 | wp_2_capabilities | a:1:{s:13:"administrator";b:1;} |
|       54 |       2 | wp_2_capabilities | a:1:{s:11:"contributor";b:1;}   |
|       58 |       3 | wp_2_capabilities | a:1:{s:6:"editor";b:1;}         |
|       60 |       3 | wp_capabilities   | a:1:{s:6:"author";b:1;}         |
+----------+---------+-------------------+---------------------------------+
6 rows in set (0.00 sec)</code></pre>
				</section>

				<section>
					<h1>Upload Directories</h1>
					<pre><code>
[jeremyfelt@wsuwp www]$ ls wp-content/uploads/sites

1     1040  1080  1122  1162  1202  1251  129   1327
100   1041  1081  1123  1163  1203  1252  1290  1328
1000  1042  1082  1124  1164  1204  1253  1291  1329
1001  1043  1084  1125  1165  1205  1254  1292  133
1002  1044  1085  1126  117   1206  1255  1294  1330
1004  1045  1087  1127  1170  1208  1257  1295  1331
1006  1046  1088  1128  1172  1209  1258  130   1332
</code></pre>

				</section>

				<section>
					<h1>Object Cache Key</h1>
					<pre><code>public function buildKey( $key, $group = 'default' ) {
    if ( empty( $group ) )
        $group = 'default';

    if ( false !== array_search( $group, $this->global_groups ) )
        $prefix = $this->global_prefix;
    else
        $prefix = $this->blog_prefix;

    return WP_CACHE_KEY_SALT . "$prefix$group:$key";
}</code></pre>
				</section>

				<section class="overview-slide">
					<h1>Bootstrap a page view</h1>
				</section>

				<section style="text-align: left;">
					<h1><pre><code>@global WP_Network $current_site</code></pre></h1>

					<pre><code class="php">$current_site->id;      // ID of the network from wp_site
$current_site->domain;
$current_site->path;    // Leading and trailing slashes
$current_site->blog_id; // The ID of the network's main site
</code></pre>
<pre><code class="mysql">mysql> SELECT * FROM wp_site;
+----+---------------------------+------+
| id | domain                    | path |
+----+---------------------------+------+
|  1 | jeremyfelt.com            | /    |
+----+---------------------------+------+
1 row in set (0.00 sec)</code></pre>
				</section>

				<section style="text-align: left;">
					<h1><pre><code>@global WP_Site $current_blog</code></pre></h1>

					<pre><code class="php">$current_blog->blog_id; // ID of the site from wp_blogs
$current_blog->site_id; // ID of the site's network
$current_blog->domain;
$current_blog->path;    // Leading and trailing slashes</code></pre>

					<pre><code>mysql> SELECT blog_id, site_id, domain, path FROM wp_blogs;
+---------+---------+----------------+----------+
| blog_id | site_id | domain         | path     |
+---------+---------+----------------+----------+
|       1 |       1 | jeremyfelt.com | /        |
|       2 |       1 | jeremyfelt.com | /photos/ |
+---------+---------+----------------+----------+
2 rows in set (0.00 sec)</code></pre>
				</section>

				<section>
					<h1>Populating <code>$current_network</code> and <code>$current_site</code></h1>

					<p><code>ms-settings.php</code></p>
					<p><code>sunrise.php</code></p>
					<p><code>ms_load_current_site_and_network();</code></p>
				</section>

				<section style="text-align: left;">
					<h1>Subdirectory Configuration</h1>

					<p>All sites on a network have the same domain and different paths</p>
					<p>Populate <span class="code">$current_site</span> first</p>
					<p>If more than one network exists, use <span class="code">get_network_by_path()</span></p>
					<p>Populate <span class="code">$current_blog</span> using <span class="code">get_site_by_path()</span></p>

				</section>

				<section style="text-align: left;">
					<h1>Subdomain Configuration</h1>

					<p>Sites on a network have different subdomains</p>
					<p>Sites can also have different paths</p>
					<p>Populate <span class="code">$current_blog</span> first using <span class="code">get_site_by_path()</span></p>
					<p>Populate <span class="code">$current_site</span> using the site_id attached to the <span class="code">$current_blog</span> object</p>
				</section>

				<section class="overview-slide">
					<h1>Plugins &amp; Themes</h1>
				</section>

				<section>
					<h1>Must Use Plugins</h1>
					<p>wp-content/mu-plugins/</p>

					<img src="images/mu-plugins-wsu.png" style="max-width:40vw;">
				</section>

				<section>
					<h1>Network Active Plugins</h1>
					<p>wp-admin/network/plugins.php</p>
				</section>

				<section>
					<h1>Site Active Plugins</h1>
					<p>wp-admin/plugins.php</p>
				</section>

				<section>
					<h1>Network Enabled Themes</h1>
				</section>

				<section>
					<h1>Site Enabled Themes</h1>
				</section>

				<section class="overview-slide">
					<h1>Context</h1>
				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<pre><code>$GLOBALS['_wp_switched_stack'][] = $GLOBALS['blog_id'];
// ...
$GLOBALS['switched'] = true;</code></pre>

					<div style="text-align: left;">
						<p>Store a record of the current context in an array that we can walk back through.</p>
					</div>
				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<pre><code>$wpdb->set_blog_id( $new_blog );
$GLOBALS['table_prefix'] = $wpdb->get_blog_prefix();
$prev_blog_id = $GLOBALS['blog_id'];
$GLOBALS['blog_id'] = $new_blog;</code></pre>

					<div style="text-align: left;">
						<p>Context changes:
							<ul>
								<li><code>$blog_id</code> property of <code>$wpdb</code></li>
								<li>Database table prefix used by <code>$wpdb</code> to <code>wp_#_</code> from <code>wp_</code></li>
								<li>Global <code>$blog_id</code></li>
							</ul>
						</p>
					</div>

				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<pre><code>wp_cache_init();
wp_cache_add_global_groups( $global_groups );
wp_cache_add_non_persistent_groups( array( ... ) );</code></pre>

					<div style="text-align: left;">
						<p>Context changes:
							<ul>
								<li>Uses the global <code>$table_prefix</code> to reinitialize object cache with keys for the switched site.</li>
							</ul>
						</p>
					</div>
				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<pre><code>$wp_roles->reinit();
$current_user = wp_get_current_user();
$current_user->for_blog( $new_blog );</code></pre>

					<div style="text-align: left;">
						<p>Context changes:
							<ul>
								<li>Uses <code>$wpdb->get_blog_prefix()</code> to set a prefix for grabbing <code>wp_#_user_roles</code> from <code>get_option()</code></li>
							</ul>
					</div>
				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<pre><code>// Delete the rewrite_rules option from
// the switched site. Good!
delete_option( 'rewrite_rules' );

// Build the permalink structure in the
// context of the main site. Bad!
$this->rewrite_rules();

// Update the rewrite_rules option for the
// switched site. Horrible!
update_option( 'rewrite_rules', $this->rules );</code></pre>
					<div style="text-align: left;">
						<p>Does not change the context of rewrite rules.</p>
						<p><a href="https://jeremyfelt.com/multisite-rewrite-rules/">https://jeremyfelt.com/multisite-rewrite-rules/</a></p>
					</div>
				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<div style="text-align: left;">
						<p>Does not change the context of code.</p>
						<p>Only the theme and plugins activated for the original site will be available.</p>
					</div>
				</section>
				<section>
					<h1><span class="code">restore_current_blog()</span></h1>

					<pre><code>if ( empty( $GLOBALS['_wp_switched_stack'] ) )
	return false;

$blog = array_pop( $GLOBALS['_wp_switched_stack'] );

// ...

$wpdb->set_blog_id( $blog );
$prev_blog_id = $GLOBALS['blog_id'];
$GLOBALS['blog_id'] = $blog;
$GLOBALS['table_prefix'] = $wpdb->get_blog_prefix();</code></pre>

					<div style="text-align: left;">
						<p>Restore context to the last used site via <code>$GLOBALS['_wp_switched_stack']</code>.</p>
					</div>

					<aside class="notes">Using the global <code>_wp_switched_stack</code> WP maintains, we're able to switch back down to where we started. Can be useful to loop this until it returns false.</aside>
				</section>

				<section>
					<h1><span class="code">ms_is_switched()</span></h1>

					<pre><code class="php">// Loop until $GLOBALS['_wp_switched_stack'] is clear.
while ( ms_is_switched() ) {
	restore_current_blog();
}</code></pre>

					<div style="text-align: left;">
						<p>Determine if context is switched and when we're back to normal.</p>
					</div>
				</section>
				<section>
					<h1><span class="code">is_main_site()</span></h1>

					<pre><code>function is_main_site( $site_id = null ) {
	// This is the current network's information
	global $current_site;

	if ( ! is_multisite() )
		return true;

	if ( ! $site_id )
		$site_id = get_current_blog_id();

	return (int) $site_id === (int) $current_site->blog_id;
}</code></pre>
				</section>

				<section>
					<h1><span class="code">is_main_network()</span></h1>

					<pre><code>function is_main_network( $network_id = null ) {
    $current_network_id = (int) get_current_site()->id;

    if ( ! $network_id )
      $network_id = $current_network_id;

    if ( defined( 'PRIMARY_NETWORK_ID' ) )
      return $network_id === (int) PRIMARY_NETWORK_ID;

    if ( 1 === $current_network_id )
      return $network_id === $current_network_id;

    if ( $primary_network_id )
      return $network_id === $primary_network_id;

    $primary_network_id = $wpdb->get_var( "SELECT id FROM $wpdb->site..." );

    return $network_id === $primary_network_id;
}</code></pre>

					<div style="text-align: left;">
						<p><code>get_main_network_id()</code> will be available in 4.3</p>
					</div>

				</section>

				<section class="so-many-h1" style="text-align: left;">
					<h1><span class="code">get_blog_details()</span></h1>
					<h1><span class="code">get_current_site()</span></h1>
				</section>

				<section class="overview-slide">
					<h1>Solutions to common requests</h1>
				</section>

				<section>
					<h1>Domain "Mapping"</h1>

					<img src="images/mercator-aliases.png">

					<p>Mercator - https://github.com/humanmade/Mercator</p>
				</section>

				<section>
					<h1>Multiple Networks</h1>

					<img src="images/wp-multi-network.png">

					<p>WP Multi Network - https://wordpress.org/plugins/wp-multi-network/</p>
				</section>

				<section>
					<h1>Content Syndication</h1>
				</section>

				<section>
					<h1>Arbitrary Domains &amp; Paths</h1>
				</section>

				<section class="overview-slide">
					<h1>WordPress 4.6</h1>
					<p>WP_Site_Query</p>
					<p>get_sites()</p>
					<p>get_site()</p>
					<p>WP_Network_Query</p>
				</section>

				<section class="title-slide">
					<h1>Multisite!</h1>
					<p>Office Hours: Tuesday, 16:00 UTC in #core-multisite</p>
					<p>Slides: <a href="https://jeremyfelt.com/wceu-2016/">jeremyfelt.com/wceu-2016/</a></p>
					<p>@jeremyfelt</p>
				</section>
			</div><!-- end .slides -->

		</div><!-- end .reveal -->

		<script src="reveal.js/lib/js/head.min.js"></script>
		<script src="reveal.js/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,

				transition: 'fade', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
					{ src: 'reveal.js/plugin/notes/notes.js', async: true }
				],

			    width: 1280,
			    height: 720,

			    // Factor of the display size that should remain empty around the content
			    margin: 0.1,

    			// Bounds for smallest/largest possible scale to apply to content
    			minScale: 0.2,
    			maxScale: 2
			});

		</script>

	</body>
</html>
