<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>Zen and the Art of Multisite Maintenance</title>

		<meta name="description" content="Slides for a talk on WordPress multisite at LoopConf 2015">
		<meta name="author" content="Jeremy Felt">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="reveal.js/css/reveal.css">
		<link rel="stylesheet" href="reveal.js/css/theme/black.css" id="theme">
		<link rel="stylesheet" href="style.css">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="reveal.js/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section class="title-slide">
					<h1>Multisite</h1>
					<p>@jeremyfelt</p>
				</section>

				<section class="overview-slide">
					<h1>History</h1>
					<aside class="notes">
						* History as context.
					</aside>
				</section>

				<section>
					<h1>b2</h1>
					<img src="images/b2.cafelog.png">
					<aside class="notes">
						Michel Valdrighi, 2001.
					</aside>
				</section>

				<section>
					<h1>???</h1>
					<p>January 24, 2003</p>
					<img title="https://web.archive.org/web/20031019094451/http://photomatt.net/p405" src="images/wp-origin-post.png">
				</section>

				<section>
					<h1>b2-smarty</h1>
					<p>February 27, 2003</p>
					<img title="https://web.archive.org/web/20030610000416/http://tidakada.com/board/viewtopic.php?t=2438" src="images/b2-smarty-announce.png">
				</section>

				<section>
					<h1>b2++</h1>
					<p>April 17, 2003</p>
					<img title="https://web.archive.org/web/20030719044701/http://blogs.linux.ie/" src="images/blogs.linux.ie.png">
					<aside class="notes">
						Donncha Ó Caoimh, named b2-smarty
					</aside>
				</section>

				<section>
					<h1>WordPress</h1>
					<p>May 26, 2003</p>
					<img title="https://web.archive.org/web/20030601131608/http://wordpress.org/development/archives/16" src="images/wp-available.png">
				</section>

				<section>
					<h1>WordPress + b2++</h1>
					<p>May 29, 2003</p>
					<img src="images/wp-b2-announce.png">
					<img src="images/wp-and-b2.png">
				</section>

				<section>
					<h1>WordPress Multiuser 0.1</h1>
					<p>October 4, 2004</p>
					<img title="http://z9.io/2004/10/04/wordpress-multiuser-01/" src="images/wp-multiuser-0.1.png">
				</section>

				<section>
					<h1>WordPressμ</h1>
					<p>July 12, 2005</p>
					<img src="images/mu-changeset-01.png">
					<aside class="notes">
						When the first changeset of MU lands, it has a handful of plugins, support for templating via Smarty, and a basic method for creating new sites on the network. Only 2 weeks later, Matt posts a notice that you can begin signing up to reserve a username.
					</aside>
				</section>

				<section>
					<h1>WordPress.com</h1>
					<p>August 8, 2005 | 142 changesets</p>
					<p>The first beta release.</p>
				</section>

				<section>
					<h1>WordPress.com</h1>
					<p>September 28, 2005 | 378 changesets</p>
					<img src="images/a-golden-ticket.png">
				</section>

				<section>
					<h1>WordPress.com</h1>
					<p>November 21, 2005 | 443 changesets</p>
					<p>Public release.</p>
				</section>

				<section>
					<h1>WordPress MU 1.0</h1>
					<p>October 10, 2006 | 801 changesets</p>
					<img src="images/changeset-801.png">
				</section>

				<section>
					<h1>WordCamp San Francisco</h1>
					<p>May 29, 2009 | 1789 changesets</p>
					<img src="images/wpmu-wp-merging.png">
					<aside class="notes">
						The intention to merge WordPress and WordPress MU is announced on May 29, 2009 during Matt's State of the Word talk at WordCamp San Francisco. At this point there are 1789 changesets in WordPress MU. It happens to be exactly 6 years since it was announced that Donncha would be joining the WordPress dev team and that b2++ would be merged into WordPress.
					</aside>
				</section>

				<section>
					<h1>#11644</h1>
					<p>December 27, 2009 | 2041 changesets</p>
					<img src="images/11644.png">
				</section>

				<section>
					<h1>[12602]</h1>
					<p>January 5, 2010 | 2044 changesets</p>
					<img src="images/first-ms-settings.png">
					<aside class="notes">Second commit after 2.9.1 was tagged.</aside>
				</section>

				<section>
					<h1>#11644 (Fixed)</h1>
					<p>March 21, 2010</p>
					<img src="images/11644-fixed.png">
				</section>

				<section class="thelonious" data-background="images/thelonious-monk-public-domain.jpg">
					<div class="thelonious-content">
						<h1>WordPress 3.0 "Thelonious"</h1>
						<p>June 17, 2010</p>
						<p><em>Use it to power one site, or 10 million.<br>Straight, no chaser.</em></p>
					</div>
					<aside class="notes"></aside>
				</section>

				<section class="overview-slide">
					<h1>Structure</h1>
					<h1>Awareness</h1>
					<h1>Extension</h1>
					<aside class="notes">
						* Provide the structure of multisite by showing what happens behind the scenes when a multisite request is made.
						* Empower with a sense of awareness by walking through sunrise possibilities.
						* Give you some immediate tips on enhancing your current multisite setup through available plugins.
					</aside>
				</section>

				<section class="overview-slide">
					<h1>Structure</h1>
				</section>
				<section class="db-slide-zero">
					<h1>The Database</h1>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables ms-tables-almost-global ms-tables-repurpose" data-markdown>
						* wp_users
						* wp_usermeta
					</div>

				</section>

				<section class="db-slide-one">
					<h1>The Database</h1>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

				</section>

				<section class="db-slide db-slide-two">
					<h1>The Database</h1>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>
					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>
					<div class="ms-tables ms-tables-new-site fragment" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site fragment" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships							
					</div>
				</section>

				<section class="db-slide db-slide-three">
					<h1>The Database</h1>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>
					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>
					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships							
					</div>
				</section>

				<section class="db-slide db-slide-four">
					<h1>The Database</h1>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_8_options
						* wp_8_posts
						* wp_8_postmeta
						* wp_8_comments
						* wp_8_commentmeta
						* wp_8_terms
						* wp_8_term_taxonomy
						* wp_8_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_9_options
						* wp_9_posts
						* wp_9_postmeta
						* wp_9_comments
						* wp_9_commentmeta
						* wp_9_terms
						* wp_9_term_taxonomy
						* wp_9_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_10_options
						* wp_10_posts
						* wp_10_postmeta
						* wp_10_comments
						* wp_10_commentmeta
						* wp_10_terms
						* wp_10_term_taxonomy
						* wp_10_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_11_options
						* wp_11_posts
						* wp_11_postmeta
						* wp_11_comments
						* wp_11_commentmeta
						* wp_11_terms
						* wp_11_term_taxonomy
						* wp_11_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_12_options
						* wp_12_posts
						* wp_12_postmeta
						* wp_12_comments
						* wp_12_commentmeta
						* wp_12_terms
						* wp_12_term_taxonomy
						* wp_12_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_13_options
						* wp_13_posts
						* wp_13_postmeta
						* wp_13_comments
						* wp_13_commentmeta
						* wp_13_terms
						* wp_13_term_taxonomy
						* wp_13_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_14_options
						* wp_14_posts
						* wp_14_postmeta
						* wp_14_comments
						* wp_14_commentmeta
						* wp_14_terms
						* wp_14_term_taxonomy
						* wp_14_term_relationships							
					</div>
				</section>

				<section class="db-slide db-slide-five">
					<h1>The Database</h1>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_8_options
						* wp_8_posts
						* wp_8_postmeta
						* wp_8_comments
						* wp_8_commentmeta
						* wp_8_terms
						* wp_8_term_taxonomy
						* wp_8_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_9_options
						* wp_9_posts
						* wp_9_postmeta
						* wp_9_comments
						* wp_9_commentmeta
						* wp_9_terms
						* wp_9_term_taxonomy
						* wp_9_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_10_options
						* wp_10_posts
						* wp_10_postmeta
						* wp_10_comments
						* wp_10_commentmeta
						* wp_10_terms
						* wp_10_term_taxonomy
						* wp_10_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_11_options
						* wp_11_posts
						* wp_11_postmeta
						* wp_11_comments
						* wp_11_commentmeta
						* wp_11_terms
						* wp_11_term_taxonomy
						* wp_11_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_12_options
						* wp_12_posts
						* wp_12_postmeta
						* wp_12_comments
						* wp_12_commentmeta
						* wp_12_terms
						* wp_12_term_taxonomy
						* wp_12_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_13_options
						* wp_13_posts
						* wp_13_postmeta
						* wp_13_comments
						* wp_13_commentmeta
						* wp_13_terms
						* wp_13_term_taxonomy
						* wp_13_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_14_options
						* wp_14_posts
						* wp_14_postmeta
						* wp_14_comments
						* wp_14_commentmeta
						* wp_14_terms
						* wp_14_term_taxonomy
						* wp_14_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_15_options
						* wp_15_posts
						* wp_15_postmeta
						* wp_15_comments
						* wp_15_commentmeta
						* wp_15_terms
						* wp_15_term_taxonomy
						* wp_15_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_16_options
						* wp_16_posts
						* wp_16_postmeta
						* wp_16_comments
						* wp_16_commentmeta
						* wp_16_terms
						* wp_16_term_taxonomy
						* wp_16_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_17_options
						* wp_17_posts
						* wp_17_postmeta
						* wp_17_comments
						* wp_17_commentmeta
						* wp_17_terms
						* wp_17_term_taxonomy
						* wp_17_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_18_options
						* wp_18_posts
						* wp_18_postmeta
						* wp_18_comments
						* wp_18_commentmeta
						* wp_18_terms
						* wp_18_term_taxonomy
						* wp_18_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_19_options
						* wp_19_posts
						* wp_19_postmeta
						* wp_19_comments
						* wp_19_commentmeta
						* wp_19_terms
						* wp_19_term_taxonomy
						* wp_19_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_20_options
						* wp_20_posts
						* wp_20_postmeta
						* wp_20_comments
						* wp_20_commentmeta
						* wp_20_terms
						* wp_20_term_taxonomy
						* wp_20_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_21_options
						* wp_21_posts
						* wp_21_postmeta
						* wp_21_comments
						* wp_21_commentmeta
						* wp_21_terms
						* wp_21_term_taxonomy
						* wp_21_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_22_options
						* wp_22_posts
						* wp_22_postmeta
						* wp_22_comments
						* wp_22_commentmeta
						* wp_22_terms
						* wp_22_term_taxonomy
						* wp_22_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_23_options
						* wp_23_posts
						* wp_23_postmeta
						* wp_23_comments
						* wp_23_commentmeta
						* wp_23_terms
						* wp_23_term_taxonomy
						* wp_23_term_relationships							
					</div>

					<aside class="notes">
					Multisite is basically using the global blogs and sites tables to figure out what other set of tables to use for the request. After that, almost everything it does is exactly the same as single site for most page loads. Remember this as it's key to understanding many things in multisite and we'll touch on it again later.
					</aside>
				</section>

				<section style="text-align: left;">
					<h1>Network: <span class="code">$current_site</span></h1>

					<pre><code class="php">$current_site->id;        // The ID of the network in the wp_site table.
$current_site->domain;
$current_site->path;      // Uses leading and trailing slashes - '/path/'
$current_site->blog_id;   // The blog_id of the network's main site.
</code></pre>
<pre><code class="mysql">mysql> SELECT * FROM wp_site;
+----+---------------------------+------+
| id | domain                    | path |
+----+---------------------------+------+
|  1 | jeremyfelt.com            | /    |
+----+---------------------------+------+
1 row in set (0.00 sec)</code></pre>
				</section>

				<section style="text-align: left;">
					<h1>Site: <span class="code">$current_blog</span></h1>

					<pre><code class="php">$current_blog->blog_id; // The ID of the site in the wp_blogs table.
$current_blog->site_id; // The ID of the site's network in the wp_site table.
$current_blog->domain;
$current_blog->path;    // Uses leading and trailing slashes - '/path/'
$current_blog->....     // More data directly from the wp_blogs record.</code></pre>

					<pre><code>mysql> SELECT blog_id, site_id, domain, path FROM wp_blogs;
+---------+---------+----------------+----------+
| blog_id | site_id | domain         | path     |
+---------+---------+----------------+----------+
|       1 |       1 | jeremyfelt.com | /        |
|       2 |       1 | jeremyfelt.com | /photos/ |
+---------+---------+----------------+----------+
2 rows in set (0.00 sec)</code></pre>
				</section>

				<section class="file-title">
					<h1>wp-includes/ms-settings.php</h1>

					<pre><code class="php">$domain = strtolower( stripslashes( $_SERVER['HTTP_HOST'] ) );

if ( substr( $domain, -3 ) == ':80' ) {
	$domain = substr( $domain, 0, -3 );
	$_SERVER['HTTP_HOST'] = substr( $_SERVER['HTTP_HOST'], 0, -3 );
} elseif ( substr( $domain, -4 ) == ':443' ) {
	$domain = substr( $domain, 0, -4 );
	$_SERVER['HTTP_HOST'] = substr( $_SERVER['HTTP_HOST'], 0, -4 );
}

$path = stripslashes( $_SERVER['REQUEST_URI'] );

if ( is_admin() ) {
	$path = preg_replace( '#(.*)/wp-admin/.*#', '$1/', $path );
}
list( $path ) = explode( '?', $path );</code></pre>
				</section>

				<section class="file-title">
					<h1>wp-includes/ms-settings.php</h1>

					<pre class="stretched"><code class="php">if ( defined( 'DOMAIN_CURRENT_SITE' ) && defined( 'PATH_CURRENT_SITE' ) ) {

  $current_site = new stdClass;
  $current_site->id = defined( 'SITE_ID_CURRENT_SITE' ) ? SITE_ID_CURRENT_SITE : 1;
  $current_site->domain = DOMAIN_CURRENT_SITE;
  $current_site->path = PATH_CURRENT_SITE;

  if ( defined( 'BLOG_ID_CURRENT_SITE' ) ) {
    $current_site->blog_id = BLOG_ID_CURRENT_SITE;
  }</code></pre>
					<h1>wp-config.php</h1>
					<pre><code class="php">define( 'DOMAIN_CURRENT_SITE', 'jeremyfelt.com' );
define( 'PATH_CURRENT_SITE',   '/'              );
define( 'SITE_ID_CURRENT_SITE', 1               );
define( 'BLOG_ID_CURRENT_SITE', 1               );</code></pre>
					<aside class="notes">
					This configuration cares nothing for whether this is a subdirectory or subdomain installation of multisite.
					</aside>
				</section>

				<section>
					<h1><span class="code">get_site_by_path()</span></h1>
					<pre><code>/**
 * Retrieve a site object by its domain and path.
 *
 * @param string   $domain   Domain to check.
 * @param string   $path     Path to check.
 * @param int|null $segments Path segments to use.
 */
function get_site_by_path( $domain, $path, $segments = null ) {

  // Use $wpdb to find matching site data from wp_blogs
  $site = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->blogs 
    WHERE domain = %s AND path = %s", $domains[0], $paths[0] ) );

}</code></pre>
				</section>

				<section>
					<h1><span class="code">get_network_by_path()</span></h1>

					<pre><code>/**
 * Retrieve a network object by its domain and path.
 *
 * @param string   $domain   Domain to check.
 * @param string   $path     Path to check.
 * @param int|null $segments Path segments to use.
 */
function get_network_by_path( $domain, $path, $segments = null ) {

  // Use $wpdb to find matching network data from wp_site
  $networks = $wpdb->get_results( "SELECT id, domain, path FROM $wpdb->site
    WHERE domain IN ($search_domains) AND path IN ($search_paths)
    ORDER BY CHAR_LENGTH(domain) DESC, CHAR_LENGTH(path) DESC" );

}</code></pre>
				</section>

				<section style="text-align: left;">
					<h1>Subdirectory Configuration</h1>

					<p>All sites on a network have the same domain and different paths</p>
					<p>Populate <span class="code">$current_site</span> first</p>
					<p>If more than one network exists, use <span class="code">get_network_by_path()</span></p>
					<p>Populate <span class="code">$current_site</span> using <span class="code">get_site_by_path()</span></p>

					<pre><code>mysql> SELECT blog_id, site_id, domain, path FROM wp_blogs;
+---------+---------+----------------+----------+
| blog_id | site_id | domain         | path     |
+---------+---------+----------------+----------+
|       1 |       1 | jeremyfelt.com | /        |
|       2 |       1 | jeremyfelt.com | /photos/ |
+---------+---------+----------------+----------+
2 rows in set (0.00 sec)</code></pre>

				</section>

				<section style="text-align: left;">
					<h1>Subdomain Configuration</h1>

					<p>Sites on a network have different subdomains</p>
					<p>Sites can also have different paths. By default all sites use <span class="code">/</span></p>
					<p>Populate <span class="code">$current_blog</span> first using <span class="code">get_site_by_path()</span></p>
					<p>Populate <span class="code">$current_site</span> using the site_id attached to the <span class="code">$current_blog</span> object</p>

					<pre><code>mysql> SELECT blog_id, site_id, domain, path FROM wp_blogs;
+---------+---------+-----------------------+----------+
| blog_id | site_id | domain                | path     |
+---------+---------+-----------------------+----------+
|       1 |       1 | jeremyfelt.com        | /        |
|       2 |       1 | photos.jeremyfelt.com | /        |
|       3 |       2 | alsoadomain.com       | /howdy/  |
+---------+---------+-----------------------+----------+
3 rows in set (0.00 sec)</code></pre>
				</section>

				<section>
					<h1><span class="code">wp_usermeta</span></h1>
					<pre><code>mysql> SELECT * FROM wp_usermeta WHERE meta_key LIKE '%_capabilities';
+----------+---------+-------------------+---------------------------------+
| umeta_id | user_id | meta_key          | meta_value                      |
+----------+---------+-------------------+---------------------------------+
|       10 |       1 | wp_capabilities   | a:1:{s:13:"administrator";b:1;} |
|       32 |       2 | wp_capabilities   | a:1:{s:13:"administrator";b:1;} |
|       47 |       1 | wp_2_capabilities | a:1:{s:13:"administrator";b:1;} |
|       54 |       2 | wp_2_capabilities | a:1:{s:11:"contributor";b:1;}   |
|       58 |       3 | wp_2_capabilities | a:1:{s:6:"editor";b:1;}         |
|       60 |       3 | wp_capabilities   | a:1:{s:6:"author";b:1;}         |
+----------+---------+-------------------+---------------------------------+
6 rows in set (0.00 sec)</code></pre>
				</section>

				<section class="overview-slide">
					<h1>Awareness</h1>
					<p>Establishing the context of existence.</p>
					<aside class="notes">Or. Establishing the context of your existence.</aside>
				</section>

				<section class="file-title">
					<h1>wp-includes/ms-settings.php</h1>

					<pre><code>/** Include Multisite initialization functions */
require_once( ABSPATH . WPINC . '/ms-load.php' );
require_once( ABSPATH . WPINC . '/ms-default-constants.php' );

if ( defined( 'SUNRISE' ) ) {
	// Load custom logic to find a network and site.
	include_once( WP_CONTENT_DIR . '/sunrise.php' );
}

ms_subdomain_constants();

if ( !isset( $current_site ) || !isset( $current_blog ) ) {
	// Default core logic to find a network and site.
}

$wpdb->set_prefix( $table_prefix, false );
$wpdb->set_blog_id( $current_blog->blog_id, $current_blog->site_id );
$table_prefix = $wpdb->get_blog_prefix();</code></pre>

					<aside class="notes">sunrise allows you to hook in before anything else is done in WordPress and determine what this page load will become. This is where you can do very custom, purposeful things that could normally be handled further down in the stack (nginx config) or up in the stack (WordPress plugin.)
				</section>

				<section class="file-title">
					<h1>wp-content/sunrise.php</h1>

					<pre class="stretched"><code>//Capture the domain and path from the current request
$req_domain    = $_SERVER['HTTP_HOST'];
$req_uri       = trim( $_SERVER['REQUEST_URI'], '/' );

// We currently support one subdirectory deep, and therefore
// only look at the first path level.
$req_uri_parts = explode( '/', $req_uri );
$req_path = $req_uri_parts[0] . '/';

wp_cache_add_global_groups( 'wsuwp:network' );
wp_cache_add_global_groups( 'wsuwp:site' );

// If we're dealing with a root domain, we want to leave it
// at a path of '/'
if ( '/' !== $req_path ) {
	$req_path = '/' . $req_path;
}

if ( ! $current_blog = wp_cache_get( $req_domain . $req_path, 'wsuwp:site' ) ) {</code></pre>
					<aside class="notes">Caching the request makes all future lookups easy. We clear the cache for a domain/path combination whenever a new site is created, and conflicts are less possible the other way around - when a page is created.</aside>
				</section>

				<section class="file-title">
					<h1>wp-content/sunrise.php</h1>

					<pre class="stretched"><code>// Start with the assumption that SSL is available for this domain.
$current_blog->ssl_enabled = true;
// We're looking for a base option name of foo.bar.com_ssl_disabled
$ssl_domain_check = $requested_domain . '_ssl_disabled';
$non_ssl_domain = $wpdb->get_row( $wpdb->prepare( "SELECT option_id FROM [...]" ) );

if ( is_object( $non_ssl_domain ) ) {
	$current_blog->ssl_enabled = false;
}

wp_cache_add( $req_domain . $req_path, $current_blog, 'wsuwp:site', 60 * 60 * 12 );</code></pre>
					<pre class="stretched"><code>if ( isset( $current_blog->ssl_enabled ) && true === $current_blog->ssl_enabled ) {
	define( 'FORCE_SSL_ADMIN', true );
	define( 'FORCE_SSL_LOGIN', true );
}</code></pre>
					<aside class="notes">We also check to see if the domain supports HTTPS. We assume by default that it does and then do a quick lookup to determine if it has been flagged as not having a cert yet.</aside>
				</section>

				<section>
					<h1><span class="code">switch_to_blog( $id )</span></h1>

					<pre><code>$wpdb->set_blog_id( $new_blog );
$GLOBALS['table_prefix'] = $wpdb->get_blog_prefix();
$prev_blog_id = $GLOBALS['blog_id'];
$GLOBALS['blog_id'] = $new_blog;</code></pre>

					<div style="text-align: left;">
						<p>Switches:
							<ul>
								<li>global <code>$blog_id</code></li>
								<li>database table prefix</li>
								<li>cache group</li>
								<li>user capabilities</li>
							</ul>
						</p>
						<p>Does not switch plugins or themes</p>
					</div>

				</section>

				<section>
					<h1><span class="code">restore_current_blog()</span></h1>

					<pre><code>if ( empty( $GLOBALS['_wp_switched_stack'] ) )
	return false;

$blog = array_pop( $GLOBALS['_wp_switched_stack'] );

// ...

$wpdb->set_blog_id( $blog );
$prev_blog_id = $GLOBALS['blog_id'];
$GLOBALS['blog_id'] = $blog;
$GLOBALS['table_prefix'] = $wpdb->get_blog_prefix();</code></pre>

					<aside class="notes">Using the global <code>_wp_switched_stack</code> WP maintains, we're able to switch back down to where we started. Can be useful to loop this until it returns false.</aside>
				</section>

				<section>
					<h1><span class="code">is_main_site()</span></h1>

					<pre><code>function is_main_site( $site_id = null ) {
	// This is the current network's information
	global $current_site;

	if ( ! is_multisite() )
		return true;

	if ( ! $site_id )
		$site_id = get_current_blog_id();

	return (int) $site_id === (int) $current_site->blog_id;
}</code></pre>
				</section>

				<section>
					<h1><span class="code">is_main_network()</span></h1>

					<pre><code>function is_main_network( $network_id = null ) {
    $current_network_id = (int) get_current_site()->id;

    if ( ! $network_id )
      $network_id = $current_network_id;

    if ( defined( 'PRIMARY_NETWORK_ID' ) )
      return $network_id === (int) PRIMARY_NETWORK_ID;

    if ( 1 === $current_network_id )
      return $network_id === $current_network_id;

    if ( $primary_network_id )
      return $network_id === $primary_network_id;

    $primary_network_id = $wpdb->get_var( "SELECT id FROM $wpdb->site..." );

    return $network_id === $primary_network_id;
}</code></pre>
				</section>

				<section class="so-many-h1" style="text-align: left;">
					<h1><span class="code">get_blog_details()</span></h1>
					<h1><span class="code">get_current_site()</span></h1>
				</section>

				<section class="overview-slide">
					<h1>Extension</h1>
				</section>

				<section>
					<h1>Must Use Plugins</h1>
					
					<p>wp-content/mu-plugins/</p>
				</section>

				<section>
					<h1>Domain "Mapping"</h1>
					<p>Mercator - https://github.com/humanmade/Mercator</p>
				</section>

				<section>
					<h1>Multiple Networks</h1>
					<p>WP Multi Network - https://wordpress.org/plugins/wp-multi-network/</p>
				</section>

				<section class="db-slide-five">
					<h1>HyperDB</h1>
					<p>https://wordpress.org/plugins/hyperdb/</p>

					<div class="ms-tables ms-tables-base" data-markdown>
						* wp_options
						* wp_posts
						* wp_postmeta
						* wp_comments
						* wp_commentmeta
						* wp_terms
						* wp_term_taxonomy
						* wp_term_relationships
					</div>

					<div class="ms-tables-global">
						<div class="ms-tables ms-tables-repurpose" data-markdown>
							* wp_users
							* wp_usermeta
						</div>

						<div class="ms-tables ms-tables-multisite" data-markdown>
							* wp_blogs
							* wp_blog_versions
							* wp_registration_log
							* wp_signups
							* wp_site
							* wp_sitemeta
						</div>
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_2_options
						* wp_2_posts
						* wp_2_postmeta
						* wp_2_comments
						* wp_2_commentmeta
						* wp_2_terms
						* wp_2_term_taxonomy
						* wp_2_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_3_options
						* wp_3_posts
						* wp_3_postmeta
						* wp_3_comments
						* wp_3_commentmeta
						* wp_3_terms
						* wp_3_term_taxonomy
						* wp_3_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_4_options
						* wp_4_posts
						* wp_4_postmeta
						* wp_4_comments
						* wp_4_commentmeta
						* wp_4_terms
						* wp_4_term_taxonomy
						* wp_4_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_5_options
						* wp_5_posts
						* wp_5_postmeta
						* wp_5_comments
						* wp_5_commentmeta
						* wp_5_terms
						* wp_5_term_taxonomy
						* wp_5_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_6_options
						* wp_6_posts
						* wp_6_postmeta
						* wp_6_comments
						* wp_6_commentmeta
						* wp_6_terms
						* wp_6_term_taxonomy
						* wp_6_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_7_options
						* wp_7_posts
						* wp_7_postmeta
						* wp_7_comments
						* wp_7_commentmeta
						* wp_7_terms
						* wp_7_term_taxonomy
						* wp_7_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_8_options
						* wp_8_posts
						* wp_8_postmeta
						* wp_8_comments
						* wp_8_commentmeta
						* wp_8_terms
						* wp_8_term_taxonomy
						* wp_8_term_relationships
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_9_options
						* wp_9_posts
						* wp_9_postmeta
						* wp_9_comments
						* wp_9_commentmeta
						* wp_9_terms
						* wp_9_term_taxonomy
						* wp_9_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_10_options
						* wp_10_posts
						* wp_10_postmeta
						* wp_10_comments
						* wp_10_commentmeta
						* wp_10_terms
						* wp_10_term_taxonomy
						* wp_10_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_11_options
						* wp_11_posts
						* wp_11_postmeta
						* wp_11_comments
						* wp_11_commentmeta
						* wp_11_terms
						* wp_11_term_taxonomy
						* wp_11_term_relationships
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_12_options
						* wp_12_posts
						* wp_12_postmeta
						* wp_12_comments
						* wp_12_commentmeta
						* wp_12_terms
						* wp_12_term_taxonomy
						* wp_12_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_13_options
						* wp_13_posts
						* wp_13_postmeta
						* wp_13_comments
						* wp_13_commentmeta
						* wp_13_terms
						* wp_13_term_taxonomy
						* wp_13_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_14_options
						* wp_14_posts
						* wp_14_postmeta
						* wp_14_comments
						* wp_14_commentmeta
						* wp_14_terms
						* wp_14_term_taxonomy
						* wp_14_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_15_options
						* wp_15_posts
						* wp_15_postmeta
						* wp_15_comments
						* wp_15_commentmeta
						* wp_15_terms
						* wp_15_term_taxonomy
						* wp_15_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_16_options
						* wp_16_posts
						* wp_16_postmeta
						* wp_16_comments
						* wp_16_commentmeta
						* wp_16_terms
						* wp_16_term_taxonomy
						* wp_16_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_17_options
						* wp_17_posts
						* wp_17_postmeta
						* wp_17_comments
						* wp_17_commentmeta
						* wp_17_terms
						* wp_17_term_taxonomy
						* wp_17_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_18_options
						* wp_18_posts
						* wp_18_postmeta
						* wp_18_comments
						* wp_18_commentmeta
						* wp_18_terms
						* wp_18_term_taxonomy
						* wp_18_term_relationships							
					</div>

					<div class="clear"></div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_19_options
						* wp_19_posts
						* wp_19_postmeta
						* wp_19_comments
						* wp_19_commentmeta
						* wp_19_terms
						* wp_19_term_taxonomy
						* wp_19_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_20_options
						* wp_20_posts
						* wp_20_postmeta
						* wp_20_comments
						* wp_20_commentmeta
						* wp_20_terms
						* wp_20_term_taxonomy
						* wp_20_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_21_options
						* wp_21_posts
						* wp_21_postmeta
						* wp_21_comments
						* wp_21_commentmeta
						* wp_21_terms
						* wp_21_term_taxonomy
						* wp_21_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_22_options
						* wp_22_posts
						* wp_22_postmeta
						* wp_22_comments
						* wp_22_commentmeta
						* wp_22_terms
						* wp_22_term_taxonomy
						* wp_22_term_relationships							
					</div>

					<div class="ms-tables ms-tables-new-site" data-markdown>
						* wp_23_options
						* wp_23_posts
						* wp_23_postmeta
						* wp_23_comments
						* wp_23_commentmeta
						* wp_23_terms
						* wp_23_term_taxonomy
						* wp_23_term_relationships							
					</div>
				</section>

				<section>
					<h1>Object Caching</h1>
				</section>

				<section class="overview-slide">
					<h1>Future</h1>
				</section>

				<section class="overview-slide">
					<h1>Future</h1>
					<h2 class="code">WP_Site, WP_Network, WP_Site_Query, WP_Network_Query</h2>
					<h2 class="fragment">Improved network admin UI/UX.</h2>
					<h2 class="fragment">Established network types.</h2>
					
				</section>
				<section class="title-slide">
					<h1>Multisite.</h1>
					<p>Office Hours: Tuesday, 20:00 UTC in #core-multisite</p>
					<p>Slides: https://jeremyfelt.com/loopconf/</p>
					<p>@jeremyfelt</p>
				</section>
			</div><!-- end .slides -->

		</div><!-- end .reveal -->

		<script src="reveal.js/lib/js/head.min.js"></script>
		<script src="reveal.js/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,

				transition: 'fade', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'reveal.js/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
					{ src: 'reveal.js/plugin/notes/notes.js', async: true }
				],

			    width: 1600,
			    height: 1066,

			    // Factor of the display size that should remain empty around the content
			    margin: 0.1,

    			// Bounds for smallest/largest possible scale to apply to content
    			minScale: 0.2,
    			maxScale: 1.5
			});

		</script>

	</body>
</html>
